{% extends "base.html" %}
{% block title %}Submit · {{ board.name }}{% endblock %}
{% block content %}
  <h1>Submit – {{ board.name }}</h1>

  {% if limit_reached %}
    <div class="card" style="max-width:600px;">
      <p>You’ve already submitted today for this board. Try another board, or come back tomorrow. ✋</p>
      <p style="margin-top:10px;">
        <a class="btn" href="/board/{{ board.slug }}">Back to board</a>
      </p>
    </div>
  {% else %}
    <div class="card" style="max-width:880px;">
      <h2>Submit today’s game</h2>
      <p>
        Scores are now imported automatically from GeoGuessr using the
        <strong>GeoLead ⇄ GeoGuessr</strong> browser extension.
      </p>

      <ol class="list" style="margin-top:8px; padding-left:20px;">
        <li>
          Finish today’s daily game on
          <a href="https://www.geoguessr.com" target="_blank" rel="noreferrer">
            geoguessr.com
          </a>.
        </li>
        <li>
          Come back to this page:
          <code>/board/{{ board.slug }}/submit</code>.
        </li>
        <li>
          Click
          <button id="geolead-import-btn" type="button" class="btn small">
            Import today’s game results
          </button>
          (the extension will send today’s scores and distances for each round).
        </li>
      </ol>

      <p class="muted" style="margin-top:12px;">
        After import you will be redirected to the <strong>Today’s round</strong> view
        for this board where you can see the map and distances for each round.
      </p>

      <p class="muted" style="margin-top:8px;">
        If you don’t see the button, make sure the extension is installed and enabled,
        and that you are logged in on both GeoGuessr and GeoLead.
      </p>
            <p class="muted" style="margin-top:16px;">
        Don’t have the browser extension yet?
        <a id="geolead-ext-install-link" href="/extensions" target="_blank" rel="noreferrer">
          Install GeoLead ⇄ GeoGuessr extension for your browser
        </a>.
      </p>

      <script>
        (function () {
          const link = document.getElementById("geolead-ext-install-link");
          if (!link) return;

          const ua = navigator.userAgent || "";
          let url = "/extensions"; // fallback, e.g. a help page on GeoLead

          // IMPORTANT: replace the placeholders below with your real store URLs
          const chromeUrl  = "https://chromewebstore.google.com/detail/REPLACE_WITH_REAL_ID";
          const edgeUrl    = "https://microsoftedge.microsoft.com/addons/detail/REPLACE_WITH_REAL_ID";
          const firefoxUrl = "https://addons.mozilla.org/en-US/firefox/addon/REPLACE_WITH_REAL_ID/";
          const safariUrl  = "https://apps.apple.com/app/idREPLACE_WITH_REAL_ID";

          if (/Firefox\/\d+/i.test(ua)) {
            url = firefoxUrl;
          } else if (/Edg\/\d+/i.test(ua)) {
            url = edgeUrl;
          } else if (/Safari/i.test(ua) && !/Chrome|Chromium|Edg/i.test(ua)) {
            url = safariUrl;
          } else {
            // default: Chrome / other Chromium browsers
            url = chromeUrl;
          }

          link.href = url;
        })();
      </script>

    </div>

    <script>
      (function () {
        const boardSlug = "{{ board.slug }}";
        const geoleadPlayerName = "{{ me.name|e }}";

        window.addEventListener("geolead:geoguessr-import", async (event) => {
          const game = event.detail || {};

          if (!game || !Array.isArray(game.rounds) || game.rounds.length === 0) {
            alert(
              "GeoLead Bridge:\n" +
              "Could not find any rounds in your last GeoGuessr game.\n" +
              "Finish today’s daily game first, then try again."
            );
            return;
          }

          const payload = {
            // This will be IGNORED by the backend for the player mapping (see below),
            // but we keep it for debugging / logging.
            player_name: geoleadPlayerName,
            board_slug: boardSlug,
            total_score: game.total_score ?? null,
            total_distance_m: game.total_distance_m ?? null,
            game_id: game.dailyQuizId || game.token || null,
            // NEW: timestamp when the extension captured the game
            played_at: game.played_at || null,
            rounds: game.rounds.slice(0, 3).map((r) => ({
              score: r.score ?? 0,
              distance_m: r.distance_m ?? null,
              guess_lat: r.guess && typeof r.guess.lat === "number" ? r.guess.lat : null,
              guess_lng: r.guess && typeof r.guess.lng === "number" ? r.guess.lng : null,
              target_lat: r.correct && typeof r.correct.lat === "number" ? r.correct.lat : null,
              target_lng: r.correct && typeof r.correct.lng === "number" ? r.correct.lng : null
            }))
          };

          try {
            const resp = await fetch("/api/geoguessr/import", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });

            const data = await resp.json().catch(() => ({}));

            if (!resp.ok) {
              const msg =
                (data && (data.detail || data.error)) ||
                "Import failed for an unknown reason.";
              alert("GeoLead Bridge:\n" + msg);
              return;
            }

            const totalScore = data.total_score ?? payload.total_score ?? "n/a";
            const totalDistKm = data.total_distance_m
              ? (data.total_distance_m / 1000).toFixed(1) + " km"
              : (payload.total_distance_m
                  ? (payload.total_distance_m / 1000).toFixed(1) + " km"
                  : "n/a");

            alert(
              "GeoLead Bridge:\n" +
              "Imported game successfully!\n" +
              "Total score: " + totalScore + "\n" +
              "Total distance: " + totalDistKm
            );

            window.location.href = "/board/" + boardSlug + "/today";
          } catch (err) {
            console.error("GeoLead Bridge import error:", err);
            alert(
              "GeoLead Bridge:\n" +
              "Import failed due to a network or server error.\n" +
              "Please try again."
            );
          }
        });
      })();
    </script>
  {% endif %}
{% endblock %}
