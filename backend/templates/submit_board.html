{% extends "base.html" %}
{% block title %}Submit · {{ board.name }}{% endblock %}

{% block content %}
  <h1>Submit – {{ board.name }}</h1>

  {% if limit_reached %}
    <div class="card" style="max-width:600px;">
      <p>You’ve already submitted today for this board. Try another board, or come back tomorrow. ✋</p>
      <p style="margin-top:10px;">
        <a class="btn" href="/board/{{ board.slug }}">Back to board</a>
      </p>
    </div>
  {% else %}

    <!-- 1) Extension import (recommended) -->
    <div class="card" style="max-width:880px; margin-bottom:18px;">
      <h2 style="margin-top:0;">Import today’s game (recommended)</h2>
      <p>
        Scores can be imported automatically from GeoGuessr using the
        <strong>GeoLead ⇄ GeoGuessr</strong> browser extension.
      </p>

      <ol class="list" style="margin-top:8px; padding-left:20px;">
        <li>
          Play today’s daily game on
          <a href="https://www.geoguessr.com" target="_blank" rel="noreferrer">
            geoguessr.com
          </a>.
          On the final results screen, <strong>click the green “Finish game” button</strong>.
        </li>
        <li>
          Come back to this page:
          <code>/board/{{ board.slug }}/submit</code>.
        </li>
        <li>
          Click
          <button id="geolead-import-btn" type="button" class="btn small">
            Import today’s game results
          </button>
          — the extension will send today’s scores and distances for each round.
        </li>
      </ol>

      <p class="muted" style="margin-top:10px;">
        After import you will be redirected to the <strong>Today’s round</strong> view
        for this board where you can see the map and distances for each round.
      </p>

      <p class="muted" style="margin-top:8px;">
        Don’t have the browser extension yet?
        <a
          id="geolead-ext-install-link"
          class="btn small"
          href="/extensions"
          target="_blank"
          rel="noreferrer"
        >
          Install the browser extension
        </a>
      </p>
    </div>

    <!-- 2) Manual submission – scores + per-round screenshot boxes (styled) -->
    <div class="card" style="max-width:880px;">
      <h2 style="margin-top:0;">Submit manually</h2>
      <p>
        If the extension doesn’t work, you can submit exactly as before:
        enter your scores for each round and paste screenshots.
      </p>

      <!-- local style for score inputs (matches .form input in your CSS) -->
      <style>
        .score-input {
          background: #0f1116;
          color: var(--text);
          border: 1px solid #2b2e35;
          border-radius: 8px;
          padding: 10px 12px;
          width: 100%;
        }
        .score-input:focus {
          outline: none;
          border-color: var(--accent);
        }
      </style>

      <form
        id="geolead-manual-form"
        method="post"
        action="/board/{{ board.slug }}/submit"
        autocomplete="off"
      >
        <!-- Scores table -->
        <div style="overflow-x:auto; margin-top:12px;">
          <table class="table">
            <thead>
              <tr>
                <th style="width:80px;">Round</th>
                <th style="width:120px;">Score</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Round 1</td>
                <td>
                  <input
                    id="geolead-score-r1"
                    type="number"
                    name="round1"
                    min="0"
                    max="5000"
                    required
                    inputmode="numeric"
                    class="score-input"
                  />
                </td>
              </tr>
              <tr>
                <td>Round 2</td>
                <td>
                  <input
                    id="geolead-score-r2"
                    type="number"
                    name="round2"
                    min="0"
                    max="5000"
                    required
                    inputmode="numeric"
                    class="score-input"
                  />
                </td>
              </tr>
              <tr>
                <td>Round 3</td>
                <td>
                  <input
                    id="geolead-score-r3"
                    type="number"
                    name="round3"
                    min="0"
                    max="5000"
                    required
                    inputmode="numeric"
                    class="score-input"
                  />
                </td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <th>Total</th>
                <th>
                  <span id="geolead-total-score">0</span>
                </th>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Hidden fields that backend expects -->
        <input type="hidden" name="screenshot_r1" id="geolead-shot-r1" />
        <input type="hidden" name="screenshot_r2" id="geolead-shot-r2" />
        <input type="hidden" name="screenshot_r3" id="geolead-shot-r3" />

        <!-- Screenshot paste boxes using your CSS -->
        <div class="paste-grid grid-3">
          <!-- Round 1 -->
          <div class="paste-wrap">
            <div
              id="geolead-paste-box-r1"
              class="paste-box"
              tabindex="0"
            >
              <div class="hint">
                <strong>Round 1</strong><br />
                Click here and press <kbd>Ctrl+V</kbd> / <kbd>⌘+V</kbd> to paste screenshot…
              </div>
              <img
                id="geolead-shot-img-r1"
                alt="Round 1 screenshot"
                style="display:none;"
              />
            </div>
          </div>

          <!-- Round 2 -->
          <div class="paste-wrap">
            <div
              id="geolead-paste-box-r2"
              class="paste-box"
              tabindex="0"
            >
              <div class="hint">
                <strong>Round 2</strong><br />
                Click here and press <kbd>Ctrl+V</kbd> / <kbd>⌘+V</kbd> to paste screenshot…
              </div>
              <img
                id="geolead-shot-img-r2"
                alt="Round 2 screenshot"
                style="display:none;"
              />
            </div>
          </div>

          <!-- Round 3 -->
          <div class="paste-wrap">
            <div
              id="geolead-paste-box-r3"
              class="paste-box"
              tabindex="0"
            >
              <div class="hint">
                <strong>Round 3</strong><br />
                Click here and press <kbd>Ctrl+V</kbd> / <kbd>⌘+V</kbd> to paste screenshot…
              </div>
              <img
                id="geolead-shot-img-r3"
                alt="Round 3 screenshot"
                style="display:none;"
              />
            </div>
          </div>
        </div>

        <p class="muted" style="margin-top:6px;">
          Screenshots are optional. You can submit scores without images if you like.
        </p>

        <div style="margin-top:16px;">
          <button type="submit" class="btn">
            Submit scores manually
          </button>
          <a href="/board/{{ board.slug }}" class="btn ghost small" style="margin-left:8px;">
            Cancel
          </a>
        </div>
      </form>
    </div>

    <!-- 3) Extension install link auto-detection -->
    <script>
      (function () {
        const link = document.getElementById("geolead-ext-install-link");
        if (!link) return;

        const ua = navigator.userAgent || "";
        let url = "/extensions";

        const chromeUrl =
          "https://chromewebstore.google.com/detail/geolead-%E2%87%84-geoguessr-bridg/ibplmeklhbagilmglbaoipeifnpmnbhe";
        const edgeUrl =
          "https://microsoftedge.microsoft.com/addons/detail/geolead-%E2%87%84-geoguessr-bridg/gidgabkenpfkmpiaohlfjgjjjneginnl";
        const firefoxUrl =
          "https://addons.mozilla.org/en-US/firefox/addon/geolead-geoguessr-bridge/";
        const safariUrl = "https://apps.apple.com/app/idREPLACE_WITH_REAL_ID";

        if (/Firefox\/\d+/i.test(ua)) {
          url = firefoxUrl;
        } else if (/Edg\/\d+/i.test(ua)) {
          url = edgeUrl;
        } else if (/Safari/i.test(ua) && !/Chrome|Chromium|Edg/i.test(ua)) {
          url = safariUrl;
        } else {
          url = chromeUrl;
        }

        link.href = url;
      })();
    </script>

    <!-- 4) Listener for extension → GeoLead import -->
    <script>
      (function () {
        const boardSlug = "{{ board.slug }}";
        const geoleadPlayerName = "{{ me.name|e if me else '' }}";

        window.addEventListener("geolead:geoguessr-import", async (event) => {
          const game = event.detail || {};

          if (!game || !Array.isArray(game.rounds) || game.rounds.length === 0) {
            alert(
              "GeoLead Bridge:\n" +
                "Could not find any rounds in your last GeoGuessr game.\n" +
                "Finish today’s daily game first (and press “Finish game” at the end), then try again."
            );
            return;
          }

          const payload = {
            player_name: geoleadPlayerName || game.player_name || "Unknown",
            board_slug: boardSlug,
            total_score: game.total_score ?? null,
            total_distance_m: game.total_distance_m ?? null,
            game_id: game.dailyQuizId || game.token || null,
            played_at: game.played_at || null,
            rounds: game.rounds.slice(0, 3).map((r) => ({
              score: r.score ?? 0,
              distance_m: r.distance_m ?? null,
              guess_lat:
                r.guess && typeof r.guess.lat === "number" ? r.guess.lat : null,
              guess_lng:
                r.guess && typeof r.guess.lng === "number" ? r.guess.lng : null,
              target_lat:
                r.correct && typeof r.correct.lat === "number"
                  ? r.correct.lat
                  : null,
              target_lng:
                r.correct && typeof r.correct.lng === "number"
                  ? r.correct.lng
                  : null,
            })),
          };

          try {
            const resp = await fetch("/api/geoguessr/import", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const data = await resp.json().catch(() => ({}));

            if (!resp.ok) {
              const msg =
                (data && (data.detail || data.error)) ||
                "Import failed for an unknown reason.";
              alert("GeoLead Bridge:\n" + msg);
              return;
            }

            const totalScore = data.total_score ?? payload.total_score ?? "n/a";
            const totalDistKm = data.total_distance_m
              ? (data.total_distance_m / 1000).toFixed(1) + " km"
              : payload.total_distance_m
              ? (payload.total_distance_m / 1000).toFixed(1) + " km"
              : "n/a";

            alert(
              "GeoLead Bridge:\n" +
                "Imported game successfully!\n" +
                "Total score: " +
                totalScore +
                "\n" +
                "Total distance: " +
                totalDistKm
            );

            window.location.href = "/board/" + boardSlug + "/today";
          } catch (err) {
            console.error("GeoLead Bridge import error:", err);
            alert(
              "GeoLead Bridge:\n" +
                "Import failed due to a network or server error.\n" +
                "Please try again."
            );
          }
        });
      })();
    </script>

    <!-- 5) Manual form behaviour: total calculation + paste boxes wired to /api/paste_image -->
    <script>
      (function () {
        const r1 = document.getElementById("geolead-score-r1");
        const r2 = document.getElementById("geolead-score-r2");
        const r3 = document.getElementById("geolead-score-r3");
        const totalEl = document.getElementById("geolead-total-score");

        function parseScore(input) {
          if (!input) return 0;
          const v = parseInt(input.value, 10);
          if (isNaN(v)) return 0;
          return Math.min(5000, Math.max(0, v));
        }

        function updateTotal() {
          const t = parseScore(r1) + parseScore(r2) + parseScore(r3);
          if (totalEl) totalEl.textContent = t.toString();
        }

        [r1, r2, r3].forEach((el) => {
          if (!el) return;
          el.addEventListener("input", updateTotal);
          el.addEventListener("blur", () => {
            const v = parseScore(el);
            if (el.value !== "" + v) el.value = v;
            updateTotal();
          });
        });
        updateTotal();

        // Screenshot paste boxes
        let activeRound = null;

        function attachPasteBox(round) {
          const box = document.getElementById("geolead-paste-box-" + round);
          if (!box) return;

          box.addEventListener("click", () => {
            activeRound = round;
            box.focus();
          });

          box.addEventListener("focus", () => {
            activeRound = round;
          });
        }

        ["r1", "r2", "r3"].forEach(attachPasteBox);

        // Clear activeRound when clicking outside paste boxes
        document.addEventListener("click", (e) => {
          if (!e.target.closest(".paste-box")) {
            activeRound = null;
          }
        });

        document.addEventListener("paste", async (event) => {
          if (!activeRound) return;

          const clipboardData = event.clipboardData || window.clipboardData;
          if (!clipboardData || !clipboardData.items) return;

          let file = null;
          for (let i = 0; i < clipboardData.items.length; i++) {
            const item = clipboardData.items[i];
            if (item.type && item.type.indexOf("image/") === 0) {
              file = item.getAsFile();
              break;
            }
          }

          if (!file) return;

          event.preventDefault();

          const box = document.getElementById("geolead-paste-box-" + activeRound);
          const hiddenInput = document.getElementById("geolead-shot-" + activeRound);
          const img = document.getElementById("geolead-shot-img-" + activeRound);

          if (!box || !hiddenInput || !img) return;

          const hint = box.querySelector(".hint");
          const oldHint = hint ? hint.textContent : "";

          const fd = new FormData();
          fd.append("image", file);

          if (hint) hint.textContent = "Uploading screenshot…";

          try {
            const resp = await fetch("/api/paste_image", {
              method: "POST",
              body: fd,
            });
            const data = await resp.json().catch(() => ({}));

            if (!resp.ok || !data || !data.url) {
              alert(
                "Screenshot upload failed. Please try again or submit without an image."
              );
            } else {
              hiddenInput.value = data.url;
              img.src = data.url;
              img.style.display = "block";
              box.classList.add("has-image");
            }
          } catch (err) {
            console.error("Screenshot upload failed:", err);
            alert(
              "Screenshot upload failed due to a network error. You can still submit without an image."
            );
          } finally {
            if (hint) hint.textContent = oldHint;
          }
        });
      })();
    </script>
  {% endif %}
{% endblock %}
