
{% extends "base.html" %}
{% block content %}
  {% if saved %}
  <div class="flash">Score saved. ðŸŽ‰</div>
  {% endif %}

  <div class="layout">
    <aside class="sidebar">
      <h2 class="sidebar-title">Boards</h2>
      <ul class="list">
        <li><a href="/board/global" class="{% if is_global %}active{% endif %}">Global (all boards)</a></li>
        {% for b in boards if b.slug != "global" %}
          <li><a href="/board/{{ b.slug }}" class="{% if not is_global and board and b.slug == board.slug %}active{% endif %}">{{ b.name }}</a></li>
        {% endfor %}
      </ul>
      {% if not is_global and board %}
      <div class="actions" style="margin-top:10px">
        <a class="btn small" href="/board/{{ board.slug }}/submit">Submit to {{ board.name }}</a>
      </div>
      {% endif %}
    </aside>

    <section class="content">
      <h1>Leaders &middot; <span class="board-name">{% if is_global %}Global{% else %}{{ board.name }}{% endif %}</span></h1>

      <div class="cards cards-2">
        <!-- All time -->
        <section class="card">
          <h2>All time</h2>
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Player</th>
                <th class="num">Entries</th>
                <th class="num">Total</th>
                <th class="num">Average</th>
                <th class="num">Max round</th>
              </tr>
            </thead>
            <tbody>
              {% if rows_all|length == 0 %}
                <tr><td colspan="6" class="muted">No scores yet.</td></tr>
              {% else %}
                {% for r in rows_all %}
                <tr>
                  <td>{{ r.rank }}</td>
                  <td><a href="/player/{{ r.player_id }}">{{ r.player_name }}</a></td>
                  <td class="num">{{ r.count }}</td>
                  <td class="num">{{ '{:,}'.format(r.total_score) }}</td>
                  <td class="num">{{ '{:,}'.format(r.average_score|round(0, 'floor')|int) }}</td>
                  <td class="num">{{ r.max_round }}</td>
                </tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </section>

        <!-- This week -->
        <section class="card">
          <h2>This week</h2>
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Player</th>
                <th class="num">Entries</th>
                <th class="num">Total</th>
                <th class="num">Average</th>
                <th class="num">Max round</th>
              </tr>
            </thead>
            <tbody>
              {% if rows_week|length == 0 %}
                <tr><td colspan="6" class="muted">No scores yet.</td></tr>
              {% else %}
                {% for r in rows_week %}
                <tr>
                  <td>{{ r.rank }}</td>
                  <td><a href="/player/{{ r.player_id }}">{{ r.player_name }}</a></td>
                  <td class="num">{{ r.count }}</td>
                  <td class="num">{{ '{:,}'.format(r.total_score) }}</td>
                  <td class="num">{{ '{:,}'.format(r.average_score|round(0, 'floor')|int) }}</td>
                  <td class="num">{{ r.max_round }}</td>
                </tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </section>
        <!-- Today (full-width) -->
        <section class="card wide" id="today-card" data-me-id="{{ me.id if me else '' }}">
          <h2 style="display:flex;align-items:center;gap:8px;">
            Today
            <span class="share-actions">
              <button class="btn small" id="copy-today">Share stats</button>
            </span>
          </h2>

          <table class="table compact today">
            <thead>
              <tr>
                <th>#</th>
                <th>Player</th>
                <th class="num">R1</th>
                <th class="num">R2</th>
                <th class="num">R3</th>
                <th class="num">Total</th>
                <th class="num"><abbr title="Average per round">Avg</abbr></th>
                <th class="num"><abbr title="Max single round">Max</abbr></th>
              </tr>
            </thead>
            <tbody>
              {% if rows_today|length == 0 %}
                <tr><td colspan="8" class="muted">No scores yet.</td></tr>
              {% else %}
                {% for r in rows_today %}
                <tr data-player-id="{{ r.player_id }}">
                  <td>{{ r.rank }}</td>
                  <td><a href="/player/{{ r.player_id }}">{{ r.player_name }}</a></td>
                  <td class="num">{{ r.round1 }}</td>
                  <td class="num">{{ r.round2 }}</td>
                  <td class="num">{{ r.round3 }}</td>
                  <td class="num">{{ '{:,}'.format(r.total_score) }}</td>
                  <td class="num">{{ '{:,}'.format(r.average_round | round(0, 'floor') | int) }}</td>
                  <td class="num">{{ r.max_round }}</td>
                </tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </section>
      </div>
    </section>
  </div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const card = document.getElementById('today-card');
  const btn  = document.getElementById('copy-today');
  if (!card || !btn) return;  // safety

  async function renderCard(){
    // Hide action buttons
    const actions = card.querySelector('.share-actions');
    const prev = actions ? actions.style.display : '';
    if (actions) actions.style.display = 'none';

    // ðŸ”¹ Highlight current user row (if present)
    const meId = card.dataset.meId;
    let hi = null, dim = [];
    if (meId) {
      hi = card.querySelector(`tbody tr[data-player-id="${meId}"]`);
      if (hi) {
        hi.classList.add('copy-highlight');
        dim = Array.from(card.querySelectorAll('tbody tr')).filter(tr => tr !== hi);
        dim.forEach(tr => tr.classList.add('copy-dim'));
      }
    }

    const canvas = await html2canvas(card, { scale: 2, backgroundColor: null, useCORS: true });

    // Cleanup
    if (hi) hi.classList.remove('copy-highlight');
    if (dim.length) dim.forEach(tr => tr.classList.remove('copy-dim'));
    if (actions) actions.style.display = prev || '';

    return canvas;
  }

  btn.addEventListener('click', async () => {
    try{
      const canvas = await renderCard();
      const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
      await navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]);
      showToast('Copied Today table as image âœ…');
    }catch(e){
      console.error(e);
      showToast('Could not copy image.');
    }
  });
});
</script>
{% endblock %}
