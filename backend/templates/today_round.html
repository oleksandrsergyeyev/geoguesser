{% extends "base.html" %}
{% block title %}Todayâ€™s round Â· {{ board.name }}{% endblock %}

{% block extra_head %}
  <!-- Leaflet CSS (for maps) -->
  <link
    rel="stylesheet"
    href="/static/leaflet/leaflet.css"
  />
{% endblock %}

{% block content %}

  <h1>
    Todayâ€™s round Â·
    <a href="/board/{{ board.slug }}">{{ board.name }}</a>
  </h1>

  {% if posts|length == 0 %}
    <p class="muted">No posts yet for today.</p>
  {% else %}

    {# ---------- 1. Aggregated maps: one per round, all players ---------- #}
    <section class="round-maps-shell">
      <div class="card round-maps-card">
        <h2 style="margin-top:4px;">Maps for todayâ€™s round</h2>

        <div class="round-maps-grid">
          <div class="round-map-wrapper">
            <div class="round-head">Round 1</div>
            <div id="round-map-1" class="round-map"></div>
          </div>
          <div class="round-map-wrapper">
            <div class="round-head">Round 2</div>
            <div id="round-map-2" class="round-map"></div>
          </div>
          <div class="round-map-wrapper">
            <div class="round-head">Round 3</div>
            <div id="round-map-3" class="round-map"></div>
          </div>
        </div>
      </div>
    </section>

    {# ---------- 2. Per-player list + screenshots ---------- #}
    <div class="posts">
      {% for p in posts %}
        <article class="card post">
          <header class="post-header">
            <div class="post-title">
              <span class="player">{{ p.name }}</span>
              <span class="meta">
                R1 {{ p.r1 }} Â·
                R2 {{ p.r2 }} Â·
                R3 {{ p.r3 }} Â·
                <strong>Total {{ "{:,}".format(p.total) }}</strong>
                {% if p.total_distance_km is not none %}
                  Â· {{ (p.total_distance_km)|round(1) }} km
                {% endif %}
              </span>
            </div>
            <time class="time">{{ p.time }}</time>
          </header>

          <div class="rounds">
            {% for r in p.rounds %}
              <div class="round">
                <div class="round-head">
                  R{{ r.index }}
                  {% if r.distance_m %}
                    Â· {{ (r.distance_m / 1000.0)|round(1) }} km
                  {% endif %}
                  {% if r.score %}
                    Â· {{ r.score }} pts
                  {% endif %}
                </div>

                {% if r.screenshot_url %}
                  <div class="shot">
                    <img
                      src="{{ r.screenshot_url }}"
                      alt="Screenshot round {{ r.index }} for {{ p.name }}"
                      style="display:block; width:100%; height:auto;"
                    />
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </article>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Leaflet JS + renderer for aggregated maps -->
  <script
    src="/static/leaflet/leaflet.js"
  ></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof L === 'undefined') {
        console.warn('Leaflet not loaded');
        return;
      }

      // round -> array of player/coords
      const roundData = { 1: [], 2: [], 3: [] };

      {% for p in posts %}
        {% for r in p.rounds %}
          {% if r.has_map
                and r.guess_lat is not none and r.guess_lng is not none
                and r.target_lat is not none and r.target_lng is not none %}
            if (!roundData[{{ r.index }}]) {
              roundData[{{ r.index }}] = [];
            }
            roundData[{{ r.index }}].push({
              playerName: "{{ (p.name or '')|replace('\\', '\\\\')|replace('\"', '\\\"') }}",
              guessLat: {{ r.guess_lat }},
              guessLng: {{ r.guess_lng }},
              targetLat: {{ r.target_lat }},
              targetLng: {{ r.target_lng }}
            });
          {% endif %}
        {% endfor %}
      {% endfor %}

      // ---------- Marker HTML builders (icon + label underneath) ----------

      function makeTargetHtml() {
        return `
          <div class="geo-marker geo-marker-target">
            <div class="geo-marker-icon">ðŸŽ¯</div>
            <div class="geo-marker-label">TARGET</div>
          </div>
        `;
      }

      function makePlayerHtml(name) {
        let label = (typeof name === 'string' ? name : '') || 'Player';
        label = label.trim();
        if (label.length > 18) {
          label = label.slice(0, 15) + 'â€¦';
        }
        const safe = label
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');

        return `
          <div class="geo-marker geo-marker-player">
            <div class="geo-marker-icon">ðŸ‘¤</div>
            <div class="geo-marker-label">${safe}</div>
          </div>
        `;
      }

      const configs = [
        { round: 1, elId: 'round-map-1' },
        { round: 2, elId: 'round-map-2' },
        { round: 3, elId: 'round-map-3' }
      ];

      configs.forEach(cfg => {
        const entries = roundData[cfg.round] || [];
        const el = document.getElementById(cfg.elId);
        if (!el) return;

        if (!entries.length) {
          el.innerHTML =
            '<div class="round-map-empty-text">No map data for this round yet.</div>';
          return;
        }

        const map = L.map(el, {
          attributionControl: false,
          zoomControl: false
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 18
        }).addTo(map);

        const bounds = L.latLngBounds([]);

        // Target (first entry defines target for the round)
        const first = entries[0];
        const targetLatLng = [first.targetLat, first.targetLng];
        L.marker(targetLatLng, {
          icon: L.divIcon({
            className: 'leaflet-div-icon',
            html: makeTargetHtml(),
            iconSize: null
          })
        }).addTo(map);
        bounds.extend(targetLatLng);

        // Each player's guess
        entries.forEach(e => {
          const guessLatLng = [e.guessLat, e.guessLng];

          L.marker(guessLatLng, {
            icon: L.divIcon({
              className: 'leaflet-div-icon',
              html: makePlayerHtml(e.playerName),
              iconSize: null
            })
          }).addTo(map);

          L.polyline([guessLatLng, targetLatLng], {
              weight: 3,                 // thicker line
              color: '#f97316',          // bright orange
              opacity: 0.9,
              dashArray: '4 4'           // dashed so it stands out
            }).addTo(map);
          bounds.extend(guessLatLng);
        });

        if (bounds.isValid()) {
          map.fitBounds(bounds.pad(0.4));
        }
      });
    });
  </script>

{% endblock %}
